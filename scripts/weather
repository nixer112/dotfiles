#!/bin/sh

# Ciudad/Ubicaci√≥n
LOCATION="Jaen"

# Obtener datos (filtramos errores de red con --fail)
WEATHER_DATA=$(curl -s --fail "wttr.in/${LOCATION}?format=j1")

if [ $? -ne 0 ] || [ -z "$WEATHER_DATA" ]; then
  echo '{"text": "Error", "tooltip": "No se pudo conectar con wttr.in"}'
  exit 1
fi

# 1. Extraer datos con jq
TEMP=$(echo "$WEATHER_DATA" | jq -r '.current_condition[0].temp_C')
WEATHER_CODE=$(echo "$WEATHER_DATA" | jq -r '.current_condition[0].weatherCode')
HORA=$(date +%H)

# 2. Funci√≥n de mapeo (Definida una sola vez)
get_emoji() {
  code=$1
  hora=$2

  # L√≥gica de d√≠a: de 07:00 a 19:59
  if [ "$hora" -ge 7 ] && [ "$hora" -lt 20 ]; then
    case "$code" in
    113) echo "‚òÄÔ∏è" ;;
    116) echo "üå§Ô∏è" ;;
    119 | 122) echo "‚òÅÔ∏è" ;;
    143 | 248 | 260 | 263 | 266 | 281 | 284 | 293 | 296 | 299 | 302 | 305 | 308 | 311 | 314 | 317 | 320 | 323 | 326 | 329 | 332 | 335 | 338 | 350 | 353 | 356 | 359 | 362 | 365 | 368 | 371 | 374 | 377 | 386 | 389 | 392 | 395) echo "üåßÔ∏è" ;;
    *) echo "‚ùì" ;;
    esac
  else
    # L√≥gica de noche
    case "$code" in
    113) echo "üåô" ;;
    116 | 119 | 122) echo "‚òÅÔ∏è" ;;
    143 | 248 | 260 | 263 | 266 | 281 | 284 | 293 | 296 | 299 | 302 | 305 | 308 | 311 | 314 | 317 | 320 | 323 | 326 | 329 | 332 | 335 | 338 | 350 | 353 | 356 | 359 | 362 | 365 | 368 | 371 | 374 | 377 | 386 | 389 | 392 | 395) echo "üåßÔ∏è" ;;
    *) echo "‚ùì" ;;
    esac
  fi
}

EMOJI=$(get_emoji "$WEATHER_CODE" "$HORA")

echo "${EMOJI} ${TEMP}¬∞C"

