#!/bin/sh

# Ciudad/Ubicaci√≥n a consultar (Ja√©n)
LOCATION="Jaen"

# Usar curl para obtener el JSON y jq para parsearlo
# Se usa wttr.in/?format=j1 (o /Jaen?format=j1) para obtener JSON.
WEATHER_DATA=$(curl -s "wttr.in/${LOCATION}?format=j1")

# Verificar si la consulta fue exitosa
if [ -z "$WEATHER_DATA" ]; then
  echo '{"text": "Clima: Error", "tooltip": "No se pudo obtener el clima"}'
  exit 1
fi

# 1. Extraer la temperatura en grados cent√≠grados (temp_C)
TEMP=$(echo "$WEATHER_DATA" | jq -r '.current_condition[0].temp_C')

# 2. Extraer el c√≥digo del tiempo (weatherCode)
WEATHER_CODE=$(echo "$WEATHER_DATA" | jq -r '.current_condition[0].weatherCode')

# Funci√≥n para mapear el c√≥digo del tiempo a un emoji
fecha=$(date | cut -d" " -f5 | cut -d: -f1)

if [ "$fecha" ] <"20" || [ "$fecha" ] >"7"; then
  get_emoji() {
    case "$1" in
    113) echo "‚òÄÔ∏è" ;; # Despejado
    116) echo "üå§Ô∏è" ;; # Parcialmente nublado
    119) echo "‚òÅÔ∏è" ;; # Nublado
    122) echo "‚òÅÔ∏è" ;; # Muy nublado/cubierto
    143 | 248 | 260 | 263 | 266 | 281 | 284 | 293 | 296 | 299 | 302 | 305 | 308 | 311 | 314 | 317 | 320 | 323 | 326 | 329 | 332 | 335 | 338 | 350 | 353 | 356 | 359 | 362 | 365 | 368 | 371 | 374 | 377 | 386 | 389 | 392 | 395)
      echo "üåßÔ∏è"
      ;; # Lluvia, Nieve, Granizo, Tormenta, etc. (ajusta seg√∫n necesites)
      # A√±ade m√°s c√≥digos si quieres m√°s precisi√≥n. Puedes consultar la documentaci√≥n de wttr.in/json
    *) echo "‚ùì" ;; # Desconocido
    esac
  }
else
  get_emoji() {
    case "$1" in
    113) echo "üåô" ;;  # Despejado
    116) echo "‚òÅÔ∏è" ;; # Parcialmente nublado
    119) echo "‚òÅÔ∏è" ;; # Nublado
    122) echo "‚òÅÔ∏è" ;; # Muy nublado/cubierto
    143 | 248 | 260 | 263 | 266 | 281 | 284 | 293 | 296 | 299 | 302 | 305 | 308 | 311 | 314 | 317 | 320 | 323 | 326 | 329 | 332 | 335 | 338 | 350 | 353 | 356 | 359 | 362 | 365 | 368 | 371 | 374 | 377 | 386 | 389 | 392 | 395)
      echo "üåßÔ∏è"
      ;; # Lluvia, Nieve, Granizo, Tormenta, etc. (ajusta seg√∫n necesites)
      # A√±ade m√°s c√≥digos si quieres m√°s precisi√≥n. Puedes consultar la documentaci√≥n de wttr.in/json
    *) echo "‚ùì" ;; # Desconocido
    esac
  }
fi
# Obtener el emoji
EMOJI=$(get_emoji "$WEATHER_CODE")

# Formatear la salida en JSON para Waybar
# Waybar espera un JSON con "text" y opcionalmente "tooltip"
echo "${EMOJI} ${TEMP}¬∞C"
